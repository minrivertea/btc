{% extends base_template %}
{% load thumbnail staticfiles mathfilters %}

{% block pagetitle %}Home{% endblock %}


{% block extrajs %}
<script type="text/javascript">

function highLight(item) {    
     
    var buyCurrency = item.attr('data-curr');
    var buyPrice = parseFloat(item.attr('data-price'));
    
    /// AMOUNTS AND CURRENCY ENTERED BY USER       
    var userAmount = $('input#user-amount').val();
    var userCurrency = $('input[name="user-currency"]:checked').val();
    
    
    /// WHAT IS TOTAL BTC BUY WITH USER AMOUNT?
    if (userCurrency == buyCurrency) {
        var btcBuy = ( userAmount / buyPrice )
    } else {
        var fx = parseFloat($('#'+userCurrency+'_'+buyCurrency).text());
        var btcBuy = ( (userAmount * fx) / buyPrice)             
    }
        
    item.find('.buy_price .price').text(buyPrice.toFixed(2));
    item.find('.buy_price .curr').text(buyCurrency);
    item.find('.btc_buy').text(btcBuy.toFixed(4));

    var bestPrice = 0;
    var bestPriceEx = '';
    
    /// UPDATE THE AMOUNTS FOR EACH SELL EXCHANGE  
    $('.exchange').not('.exchange.excluded').each(function(i,v) {
        
        
        
        if (item.find('.buy_from .name').text() == $(v).find('.sell_on').text() ) {
           $(v).addClass('grey');   
        } else {
           $(v).removeClass('grey');   
        }
         
        var sellPrice = parseFloat($(v).attr('data-price'));
        var sellCurrency = $(v).attr('data-curr');
        
        $(v).find('.sell_price .price').text(sellPrice.toFixed(2));
        $(v).find('.sell_price .curr').text(sellCurrency);

        /// FIND THE PRICE DIFFERENCE BETWEEN THE BUY/SELL EXCHANGES
        var fx = parseFloat($('#'+sellCurrency+'_'+buyCurrency).text());
        
        
        var totalSellPrice = (sellPrice * btcBuy)
        var fx = parseFloat( $('#'+sellCurrency+'_'+userCurrency).text() );
        var totalSellPriceOriginalCurrency = (totalSellPrice * fx)
        
        
        var original = ( totalSellPrice.toFixed(2) + ' ' + sellCurrency)
        $(v).find('.total_out').attr('title', original) ;
        $(v).find('.total_out .price').text(totalSellPriceOriginalCurrency.toFixed(2));
        $(v).find('.total_out .curr').text(userCurrency);
        
        
        
        var profitLoss = (totalSellPriceOriginalCurrency - userAmount );
        $(v).find('.profit_loss .price').text(profitLoss.toFixed(2));
        $(v).find('.profit_loss .curr').text(userCurrency);
        
        

        if (profitLoss < 0) {
             $(v).addClass('red');
        } else {
             $(v).removeClass('red');   
        } 
        
        /// MINIMUM SELL PRICE TO GET A ZERO-SUM
        var fx = parseFloat( $('#'+buyCurrency+'_'+sellCurrency).text() );
        var minSell = (buyPrice * fx)
        
                
        /// PERCENTAGE
        var percent = ( (profitLoss / totalSellPriceOriginalCurrency) * 100 ).toFixed(2)
        
        /// BEST PRICE
        if (totalSellPriceOriginalCurrency > bestPrice) {
           bestPrice = totalSellPriceOriginalCurrency ;
           bestPriceEx = '';
           bestPriceEx = $(v).find('.sell_on').text();
        }
        
        /// UPDATE ALL THE DATA IN THE TABLE
        $(v).find('.percent .num').text(percent);
        $(v).find('.min_sell .price').text(minSell.toFixed(2));
        $(v).find('.min_sell .curr').text(sellCurrency);
        
        
         
    }); 
    
    
    $('.excluded td span').not('.buy_from span, .sell_on, .exclude span').text('');
    $('#best_price .price').text(bestPrice.toFixed(2));
    $('#best_price .currency').text(userCurrency);
    $('#best_price .exchange').text(bestPriceEx);
            
}


$(document).ready( function() {
   
   /// SETUP THE MAIN TABLE OF EXCHANGES AND DATA
   $('.buy_from').click( function() {
      
      /// CLEAR ALL OTHERS
      $('.buy_from').parent('.exchange').removeClass('selected');
      $('.buy_price .price').text('');
      $('.buy_price .curr').text('');
      $('.btc_buy').text('');
      
      $(this).parent('.exchange').toggleClass('selected');
      highLight( $(this).parent('tr') );     
   });
   
   /// SETUP THE RADIO BUTTONS
   $('#radios input[type="radio"]:checked').parent('label').addClass('selected');
   $('#radios input[type="radio"]').click( function() {
      $('#radios input[type="radio"]').parent('label').removeClass('selected');
      $('#radios input[type="radio"]:checked').parent('label').addClass('selected');
      
      highLight( $('.exchange.selected') );
      
   });
   
   /// SETUP THE EXCLUDE BUTTON
   
   
   $('.exclude a').click( function(e) {
      $(this).parent('td').parent('tr').toggleClass('excluded');
            
      if ($('.text', this).text() == '+') {
          $('.text', this).text('x');
      } else {
          $('.text', this).text('+');
      }
      highLight( $('.exchange.selected') );
      e.preventDefault();
   });
   
   
   
   
});
</script>
{% endblock %}

{% block extracss %}
<style type="text/css">

#user_amounts {
  float: left;
  width: 100%;
  margin: 0 0 20px 0;
  border-bottom: 1px solid #fff;
  padding: 0 0 10px 0;   
}

#user_amounts #user-amount {
  float: left; 
  margin: 0 5px 0 0;
  background: none;
  padding: 0;
  font-size: 50px;
  font-weight: bold;
  color: #333;
  width: 100px;
  line-height: 0.8em;
  height: 45px;  
}

#user_amounts #radios {
  float: left;
  width: auto;
  position: relative;
  top: 10px;   
}

#best_price {
  float: right;
  text-align: right;
  position: relative;
}

#best_price .price {
  font-size: 50px;
  font-weight: bold; 
  line-height: 0.9em;  
}

#best_price .currency {
  font-size: 20px;
  font-weight: bold;   
}

#radios label {
  background: #f1f1f1;
  color: #999;
  padding: 5px 8px 2px;
  width: auto;
  margin: 0px 0 0; 
  font-weight: normal;  
}

#radios label:hover {
  cursor: pointer;
  background: #f6f6f6;   
}

#radios label.selected {
  color: #333;
  background: #fff;
  font-weight: bold;   
}

#radios input[type="radio"] {
  display: none;   
}


table#list {
  float: left;
  font-size: 13px; 
}

#list td {
  padding: 5px 10px;
  border-bottom: 3px solid #f1f1f1;  
  width: 80px; 
}

#list td.exclude {
  width: 10px; 
  position: relative;  
}


#list .buy_from {
  background: none;
  color: #999;   
}

#list .buy_from:hover {
  background: #f9f9f9;
  cursor: pointer;   
}

#list .exchange.selected .buy_from, #list .exchange.selected .buy_price, #list .exchange.selected .btc_buy {
  background: #fff;
  color: #333;   
}

#list .exchange .sell_on, #list .exchange .sell_price, #list .exchange .total_out, #list .exchange .percent, #list .exchange .profit_loss, #list .exchange .min_sell  {
  background: #fff; 
}    

#list .buy_from.red {
  color: #D30000;   
}


.grey .sell_on, .grey .sell_price, .grey .total_out, .grey .profit_loss, .grey .min_sell, .grey .percent {
  color: #d1d1d1;   
}




#fx_rates {
  display: none;   
}

</style>
{% endblock %}


{% block content %}
<div class="pure-g-r">
    <div class="pure-u-1">
        
        <div id="user_amounts">
            <input type="text" value="" id="user-amount" value="100" class="clearMeFocus"/>
            <div id="radios">
            <label><input type="radio" name="user-currency" checked="checked" value="GBP">GBP</label>
            <label><input type="radio" name="user-currency" value="USD">USD</label>
            <label><input type="radio" name="user-currency" value="EUR">EUR</label>
            <label><input type="radio" name="user-currency" value="RMB">RMB</label>
            </div>
            <div id="best_price">
                <span class="price"></span>
                <span class="currency"></span>
                on <span class="exchange"></span>
            </div>
        </div>
        
        
        <table id="list">
        
            <thead>
                <td style="width:10px;" class="">&nbsp;</td>
                <td>Buy from</td>
                <td>Price</td>
                <td>BTC Buy</td>
                <td>Sell on</td>
                <td>Sell price</td>
                <td>Total out</td>
                <td>+ / -</td>
                <td>Percent</td>
                <td>Min-sell</td>
            </thead>
            
            {% for x in buy_data %}
            {% if x.name %}
                <tr id="{{ x.name }}" class="exchange" data-price="{{ x.price|floatformat:'2' }}" data-curr="{{ x.curr }}">
                    <td class="exclude">
                        <a href=""><span class="text">X</span></a>
                    </td>
                    <td class="buy_from">
                        
                        <span class="name">{{ x.name }}</span>
                    </td>
                    <td class="buy_price">
                        
                        <span class="price"></span>
                        <span class="curr"></span>
                    </td>
                    <td class="btc_buy"></td>
                    <td class="sell_on">{{ x.name }}</td>
                    <td class="sell_price">
                        <span class="price"></span>
                        <span class="curr"></span>
                    </td>
                    <td class="total_out">
                        <span class="price"></span>
                        <span class="curr"></span>
                    </td>
                    <td class="profit_loss">
                        <span class="price"></span>
                        <span class="curr"></span>
                    </td>
                    <td class="percent">
                        <span class="num"></span> %
                    </td>
                    <td class="min_sell">
                        <span class="price"></span>
                        <span class="curr"></span>
                    </td> 
                </tr>
            {% endif %}
            {% endfor %}
            

        
        
        <ul id="fx_rates">
            {% for k,v in fx_rates.items %}
                <li id="{{ k }}">{{ v }}</li>
            {% endfor %}  
                <li id="GBP_GBP">1</li>
                <li id="RMB_RMB">1</li>
                <li id="USD_USD">1</li>
                <li id="EUR_EUR">1</li>      
        </ul>
        
        
        
    </div>

</div>
{% endblock %}
